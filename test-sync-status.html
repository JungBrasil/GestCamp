<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Status da Sincroniza√ß√£o</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-item {
            margin: 15px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ddd;
        }
        .status-ok {
            background-color: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .status-error {
            background-color: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .status-warning {
            background-color: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .test-button {
            background-color: #28a745;
        }
        .test-button:hover {
            background-color: #1e7e34;
        }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de Sincroniza√ß√£o Autom√°tica</h1>
        
        <div id="status-container">
            <div class="status-item status-warning">
                <strong>‚è≥ Verificando status...</strong>
            </div>
        </div>
        
        <div style="margin: 20px 0;">
            <button onclick="checkSyncStatus()">üîÑ Verificar Status</button>
            <button onclick="testManualSync()" class="test-button">üß™ Testar Sincroniza√ß√£o Manual</button>
            <button onclick="testAutoSync()" class="test-button">‚ö° Testar Sincroniza√ß√£o Autom√°tica</button>
            <button onclick="clearLogs()">üóëÔ∏è Limpar Logs</button>
        </div>
        
        <div id="logs-container">
            <h3>üìã Logs de Diagn√≥stico</h3>
            <pre id="logs"></pre>
        </div>
    </div>

    <script src="supabase-config.js"></script>
    <script>
        let logs = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            updateLogsDisplay();
        }
        
        function updateLogsDisplay() {
            document.getElementById('logs').textContent = logs.join('\n');
        }
        
        function clearLogs() {
            logs = [];
            updateLogsDisplay();
        }
        
        function updateStatus(items) {
            const container = document.getElementById('status-container');
            container.innerHTML = '';
            
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = `status-item status-${item.type}`;
                div.innerHTML = `<strong>${item.icon} ${item.title}</strong><br>${item.message}`;
                container.appendChild(div);
            });
        }
        
        async function checkSyncStatus() {
            addLog('Iniciando verifica√ß√£o de status da sincroniza√ß√£o...');
            const statusItems = [];
            
            try {
                // 1. Verificar configura√ß√£o do Supabase
                const config = localStorage.getItem('supabaseConfig');
                if (!config) {
                    statusItems.push({
                        type: 'error',
                        icon: '‚ùå',
                        title: 'Configura√ß√£o do Supabase',
                        message: 'Supabase n√£o configurado. Use o bot√£o "‚öôÔ∏è Configurar Nuvem" na aplica√ß√£o principal.'
                    });
                    addLog('Supabase n√£o configurado', 'error');
                } else {
                    const { url, key } = JSON.parse(config);
                    statusItems.push({
                        type: 'ok',
                        icon: '‚úÖ',
                        title: 'Configura√ß√£o do Supabase',
                        message: `URL: ${url}<br>Chave configurada: ${key ? 'Sim' : 'N√£o'}`
                    });
                    addLog(`Supabase configurado - URL: ${url}`);
                }
                
                // 2. Verificar conex√£o
                const isConnected = typeof checkSupabaseConnection === 'function' ? checkSupabaseConnection() : false;
                if (isConnected) {
                    statusItems.push({
                        type: 'ok',
                        icon: 'üåê',
                        title: 'Conex√£o com Supabase',
                        message: 'Conectado e pronto para sincronizar'
                    });
                    addLog('Conex√£o com Supabase: OK');
                } else {
                    statusItems.push({
                        type: 'error',
                        icon: 'üîå',
                        title: 'Conex√£o com Supabase',
                        message: 'N√£o conectado. Verifique a configura√ß√£o.'
                    });
                    addLog('Conex√£o com Supabase: FALHOU', 'error');
                }
                
                // 3. Verificar fun√ß√£o de sincroniza√ß√£o autom√°tica
                const hasAutoSync = typeof window.syncTimeout !== 'undefined' || 
                                  document.querySelector('script').textContent.includes('syncTimeout');
                if (hasAutoSync) {
                    statusItems.push({
                        type: 'ok',
                        icon: '‚ö°',
                        title: 'Sincroniza√ß√£o Autom√°tica',
                        message: 'Sistema de sincroniza√ß√£o autom√°tica detectado'
                    });
                    addLog('Sistema de sincroniza√ß√£o autom√°tica: ATIVO');
                } else {
                    statusItems.push({
                        type: 'warning',
                        icon: '‚ö†Ô∏è',
                        title: 'Sincroniza√ß√£o Autom√°tica',
                        message: 'Sistema de sincroniza√ß√£o autom√°tica n√£o detectado'
                    });
                    addLog('Sistema de sincroniza√ß√£o autom√°tica: N√ÉO DETECTADO', 'warning');
                }
                
                // 4. Verificar dados locais
                const localData = localStorage.getItem('eventManagerData');
                if (localData) {
                    const data = JSON.parse(localData);
                    const acampamentos = data.acampamentos ? data.acampamentos.length : 0;
                    statusItems.push({
                        type: 'ok',
                        icon: 'üíæ',
                        title: 'Dados Locais',
                        message: `${acampamentos} acampamentos encontrados localmente`
                    });
                    addLog(`Dados locais: ${acampamentos} acampamentos`);
                } else {
                    statusItems.push({
                        type: 'warning',
                        icon: 'üì≠',
                        title: 'Dados Locais',
                        message: 'Nenhum dado local encontrado'
                    });
                    addLog('Nenhum dado local encontrado', 'warning');
                }
                
            } catch (error) {
                statusItems.push({
                    type: 'error',
                    icon: 'üí•',
                    title: 'Erro no Diagn√≥stico',
                    message: `Erro: ${error.message}`
                });
                addLog(`Erro no diagn√≥stico: ${error.message}`, 'error');
            }
            
            updateStatus(statusItems);
            addLog('Verifica√ß√£o de status conclu√≠da');
        }
        
        async function testManualSync() {
            addLog('Testando sincroniza√ß√£o manual...');
            
            try {
                if (typeof SupabaseSync === 'undefined') {
                    addLog('Classe SupabaseSync n√£o encontrada', 'error');
                    return;
                }
                
                if (typeof SupabaseSync.syncAllData === 'function') {
                    await SupabaseSync.syncAllData();
                    addLog('Sincroniza√ß√£o manual executada com sucesso');
                } else {
                    addLog('M√©todo syncAllData n√£o encontrado', 'error');
                }
            } catch (error) {
                addLog(`Erro na sincroniza√ß√£o manual: ${error.message}`, 'error');
            }
        }
        
        async function testAutoSync() {
            addLog('Testando sincroniza√ß√£o autom√°tica...');
            
            try {
                // Simular uma altera√ß√£o de dados
                const testData = { test: true, timestamp: Date.now() };
                localStorage.setItem('test_sync_trigger', JSON.stringify(testData));
                
                // Verificar se a fun√ß√£o saveData existe e execut√°-la
                if (typeof saveData === 'function') {
                    saveData();
                    addLog('Fun√ß√£o saveData executada - sincroniza√ß√£o autom√°tica deve ser acionada em 2 segundos');
                    
                    setTimeout(() => {
                        addLog('Verificando se sincroniza√ß√£o autom√°tica foi executada...');
                        if (window.syncTimeout) {
                            addLog('Timer de sincroniza√ß√£o autom√°tica detectado - funcionando!');
                        } else {
                            addLog('Timer de sincroniza√ß√£o autom√°tica n√£o detectado', 'warning');
                        }
                    }, 3000);
                } else {
                    addLog('Fun√ß√£o saveData n√£o encontrada', 'error');
                }
            } catch (error) {
                addLog(`Erro no teste de sincroniza√ß√£o autom√°tica: ${error.message}`, 'error');
            }
        }
        
        // Executar verifica√ß√£o inicial
        window.addEventListener('load', () => {
            setTimeout(checkSyncStatus, 1000);
        });
    </script>
</body>
</html>