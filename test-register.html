<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Registro - EventManager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            color: #dc3545;
        }
        .success {
            color: #28a745;
        }
        .info {
            color: #17a2b8;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Teste de Registro de Usu√°rio</h1>
        <p>Esta p√°gina testa especificamente o registro de usu√°rios no Supabase.</p>
        
        <div style="margin-bottom: 20px;">
            <button type="button" onclick="testSupabaseConfig()" style="margin-right: 10px;">üîß Testar Configura√ß√£o</button>
            <button type="button" onclick="checkAuthSettings()" style="margin-right: 10px;">üîê Verificar Auth</button>
            <button type="button" onclick="testNetworkConnection()">üåê Testar Rede</button>
        </div>
        
        <form id="test-register-form">
            <div class="form-group">
                <label for="test-name">Nome Completo:</label>
                <input type="text" id="test-name" value="Usu√°rio Teste" required>
            </div>
            
            <div class="form-group">
                <label for="test-email">Email:</label>
                <input type="email" id="test-email" value="" required placeholder="Digite um email √∫nico para teste">
            </div>
            
            <div class="form-group">
                <label for="test-password">Senha:</label>
                <input type="password" id="test-password" value="123456789" required>
            </div>
            
            <div class="form-group">
                <label for="test-confirm-password">Confirmar Senha:</label>
                <input type="password" id="test-confirm-password" value="123456789" required>
            </div>
            
            <button type="submit">üöÄ Testar Registro</button>
        </form>
        
        <div id="log" class="log">Aguardando teste...
</div>
    </div>

    <!-- Carregar Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="supabase-config.js"></script>
    
    <script>
        const logElement = document.getElementById('log');
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        document.getElementById('test-register-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            addLog('üß™ Iniciando teste de registro...', 'info');
            
            const name = document.getElementById('test-name').value;
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            const confirmPassword = document.getElementById('test-confirm-password').value;
            
            addLog(`üìù Dados do formul√°rio:`, 'info');
            addLog(`   Nome: ${name}`, 'info');
            addLog(`   Email: ${email}`, 'info');
            addLog(`   Senha: ${'*'.repeat(password.length)}`, 'info');
            
            // Valida√ß√µes
            if (!name || !email || !password || !confirmPassword) {
                addLog('‚ùå Erro: Todos os campos s√£o obrigat√≥rios', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                addLog('‚ùå Erro: As senhas n√£o coincidem', 'error');
                return;
            }
            
            if (password.length < 6) {
                addLog('‚ùå Erro: A senha deve ter pelo menos 6 caracteres', 'error');
                return;
            }
            
            addLog('‚úÖ Valida√ß√µes passaram', 'success');
            
            // Testar conex√£o com Supabase
            addLog('üîó Testando conex√£o com Supabase...', 'info');
            
            if (!window.supabase) {
                addLog('‚ùå Erro: Cliente Supabase n√£o est√° dispon√≠vel', 'error');
                return;
            }
            
            addLog('‚úÖ Cliente Supabase dispon√≠vel', 'success');
            
            // Testar AuthManager
            if (!window.AuthManager) {
                addLog('‚ùå Erro: AuthManager n√£o est√° dispon√≠vel', 'error');
                return;
            }
            
            addLog('‚úÖ AuthManager dispon√≠vel', 'success');
            
            try {
                // Primeiro, testar diretamente com o cliente Supabase
                addLog('üîç Testando cliente Supabase diretamente...', 'info');
                
                const directResult = await window.supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: { full_name: name }
                    }
                });
                
                addLog('üìã Resultado direto do Supabase:', 'info');
                addLog(`   Data: ${JSON.stringify(directResult.data, null, 2)}`, 'info');
                addLog(`   Error: ${JSON.stringify(directResult.error, null, 2)}`, directResult.error ? 'error' : 'info');
                
                if (directResult.error) {
                    addLog('‚ùå Erro no registro direto:', 'error');
                    addLog(`   Mensagem: ${directResult.error.message}`, 'error');
                    addLog(`   C√≥digo: ${directResult.error.code || 'N/A'}`, 'error');
                    
                    // An√°lise espec√≠fica de erros
                    if (directResult.error.message.includes('Email rate limit exceeded')) {
                        addLog('‚è∞ Limite de taxa de email excedido - tente novamente mais tarde', 'error');
                    } else if (directResult.error.message.includes('User already registered')) {
                        addLog('üë§ Usu√°rio j√° registrado com este email', 'error');
                    } else if (directResult.error.message.includes('Invalid email')) {
                        addLog('üìß Email inv√°lido', 'error');
                    } else if (directResult.error.message.includes('Password should be at least')) {
                        addLog('üîí Senha muito fraca', 'error');
                    } else if (directResult.error.message.includes('Signup is disabled')) {
                        addLog('üö´ Registro desabilitado no projeto Supabase', 'error');
                    }
                    return;
                }
                
                addLog('‚úÖ Registro direto realizado com sucesso!', 'success');
                
                // Agora testar com AuthManager
                addLog('üì§ Testando AuthManager.signUp...', 'info');
                
                const result = await AuthManager.signUp(email + '.test', password, { full_name: name });
                
                addLog('‚úÖ AuthManager tamb√©m funcionou!', 'success');
                addLog(`üìã Resultado AuthManager: ${JSON.stringify(result, null, 2)}`, 'success');
                
            } catch (error) {
                addLog('‚ùå Erro no registro:', 'error');
                addLog(`   Mensagem: ${error.message}`, 'error');
                addLog(`   C√≥digo: ${error.code || 'N/A'}`, 'error');
                addLog(`   Stack: ${error.stack}`, 'error');
                
                // Verificar se √© erro de rede
                if (error.message.includes('fetch') || error.message.includes('Failed to fetch')) {
                    addLog('üåê Problema de conectividade de rede detectado', 'error');
                    addLog('üí° Sugest√µes:', 'info');
                    addLog('   - Verifique sua conex√£o com a internet', 'info');
                    addLog('   - Verifique se o URL do Supabase est√° correto', 'info');
                    addLog('   - Verifique se n√£o h√° bloqueio de CORS', 'info');
                }
                
                // Verificar se √© erro de configura√ß√£o
                if (error.message.includes('Invalid API key') || error.message.includes('Invalid URL')) {
                    addLog('üîë Problema de configura√ß√£o do Supabase detectado', 'error');
                    addLog('üí° Verifique as credenciais no arquivo supabase-config.js', 'info');
                }
            }
        });
        
        // Fun√ß√µes de teste adicionais
        async function testSupabaseConfig() {
            addLog('üîß Testando configura√ß√£o do Supabase...', 'info');
            
            if (!window.supabase) {
                addLog('‚ùå Cliente Supabase n√£o dispon√≠vel', 'error');
                return;
            }
            
            try {
                // Testar se consegue fazer uma consulta b√°sica
                const { data, error } = await window.supabase.from('acampamentos').select('count').limit(1);
                
                if (error) {
                    addLog(`‚ùå Erro na consulta: ${error.message}`, 'error');
                    if (error.message.includes('relation "acampamentos" does not exist')) {
                        addLog('üí° Tabelas n√£o criadas - execute o schema SQL no Supabase', 'info');
                    }
                } else {
                    addLog('‚úÖ Configura√ß√£o b√°sica funcionando', 'success');
                }
            } catch (error) {
                addLog(`‚ùå Erro de configura√ß√£o: ${error.message}`, 'error');
            }
        }
        
        async function checkAuthSettings() {
            addLog('üîê Verificando configura√ß√µes de autentica√ß√£o...', 'info');
            
            if (!window.supabase) {
                addLog('‚ùå Cliente Supabase n√£o dispon√≠vel', 'error');
                return;
            }
            
            try {
                // Verificar se o signup est√° habilitado tentando um email inv√°lido
                const testResult = await window.supabase.auth.signUp({
                    email: 'test-invalid-email-format',
                    password: '123456'
                });
                
                if (testResult.error) {
                    if (testResult.error.message.includes('Signup is disabled')) {
                        addLog('‚ùå Registro est√° DESABILITADO no projeto Supabase', 'error');
                        addLog('üí° V√° para Authentication > Settings no painel do Supabase', 'info');
                        addLog('üí° Habilite "Enable email confirmations" se necess√°rio', 'info');
                    } else if (testResult.error.message.includes('Invalid email')) {
                        addLog('‚úÖ Registro est√° habilitado (email inv√°lido detectado)', 'success');
                    } else {
                        addLog(`‚ö†Ô∏è Erro inesperado: ${testResult.error.message}`, 'error');
                    }
                } else {
                    addLog('‚ö†Ô∏è Resultado inesperado - sem erro com email inv√°lido', 'info');
                }
            } catch (error) {
                addLog(`‚ùå Erro ao verificar auth: ${error.message}`, 'error');
            }
        }
        
        async function testNetworkConnection() {
            addLog('üåê Testando conectividade de rede...', 'info');
            
            try {
                // Testar conex√£o direta com o Supabase
                const supabaseUrl = 'https://ymislcrrkcroahikwcm.supabase.co';
                
                addLog(`üì° Testando conex√£o com ${supabaseUrl}...`, 'info');
                
                const response = await fetch(`${supabaseUrl}/rest/v1/`, {
                    method: 'GET',
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltaXNsY3Jya2Nyb2VhaGlrd2NtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODMwMzMsImV4cCI6MjA3MjY1OTAzM30.3usCMB-JMaHNgzhNW7Tolp2oOz8BzqV5yDLA69BFV_Q'
                    }
                });
                
                if (response.ok) {
                    addLog('‚úÖ Conex√£o de rede funcionando', 'success');
                    addLog(`üìä Status: ${response.status}`, 'info');
                } else {
                    addLog(`‚ùå Erro HTTP: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                addLog(`‚ùå Erro de rede: ${error.message}`, 'error');
                
                if (error.message.includes('Failed to fetch')) {
                    addLog('üí° Poss√≠veis causas:', 'info');
                    addLog('   - Sem conex√£o com internet', 'info');
                    addLog('   - Firewall bloqueando', 'info');
                    addLog('   - Problema de CORS', 'info');
                    addLog('   - URL do Supabase incorreto', 'info');
                }
            }
        }
        
        // Inicializar logs
        addLog('üöÄ P√°gina de teste carregada', 'success');
        addLog('üìã Verificando depend√™ncias...', 'info');
        
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (window.supabase) {
                    addLog('‚úÖ Supabase carregado', 'success');
                } else {
                    addLog('‚ùå Supabase n√£o carregado', 'error');
                }
                
                if (window.AuthManager) {
                    addLog('‚úÖ AuthManager carregado', 'success');
                } else {
                    addLog('‚ùå AuthManager n√£o carregado', 'error');
                }
                
                addLog('üéØ Pronto para testar!', 'success');
                addLog('üí° Use os bot√µes acima para diagn√≥sticos espec√≠ficos', 'info');
            }, 1000);
        });
    </script>
</body>
</html>